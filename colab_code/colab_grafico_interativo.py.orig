<<<<<<< HEAD:colab_code/grafico_interativo.py
#@title Mapa Interativo por Regi√£o Administrativa com Dropdown

# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
# Importa√ß√µes
import geopandas as gpd
=======
 @title
>>>>>>> otimizacao_de_carga:colab_code/colab_grafico_interativo.py
import pandas as pd
import folium
import numpy as np
from shapely import wkt
from google.colab import output
import ipywidgets as widgets
from IPython.display import display, clear_output

# Ativa widgets no Colab
output.enable_custom_widget_manager()

<<<<<<< HEAD:colab_code/grafico_interativo.py
# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
# Configura√ß√£o de cores por categoria
CORES = {
=======
def get_latest_dataset():
    # Caminho da pasta onde est√£o os datasets
    pasta_datasets = '/content/drive/MyDrive/data_to_colab/' #/Projetos/2024-governanca-fundiaria/[DATA-TO-ANALYSIS]/

    # Padr√£o de nome dos arquivos
    prefixo = 'dataset-malha-fundiaria-idace_preprocessado-'
    sufixo = '.csv'

    # Listar todos os arquivos na pasta
    arquivos = os.listdir(pasta_datasets)

    # Filtrar s√≥ os arquivos que seguem o padr√£o
    arquivos_dataset = [f for f in arquivos if f.startswith(prefixo) and f.endswith(sufixo)]

    if not arquivos_dataset:
        raise FileNotFoundError("Nenhum arquivo de dataset encontrado no diret√≥rio especificado.")
    # Ordenar os arquivos com base no timestamp no nome (mais novo por √∫ltimo)
    arquivos_dataset.sort()

    # Pegar o mais novo
    arquivo_mais_recente = arquivos_dataset[-1]

    # Retornar o caminho completo para o arquivo
    return os.path.join(pasta_datasets, arquivo_mais_recente)

# Carga do dataset mais atual
caminho_dataset = get_latest_dataset()
try:
  data = pd.read_csv(caminho_dataset, low_memory=False)
  print(f"Dataset carregado com sucesso: {caminho_dataset}")
except Exception as e:
  print(f"Erro ao carregar o dataset: {e}")


# =============================================================================
# Fun√ß√µes de Filtragem e Classifica√ß√£o
# =============================================================================

def filtrar_dados(data, filtro, entidade):
    """
    Filtra o DataFrame 'data' conforme o tipo de filtro:
      - "Munic√≠pios": filtra pelo nome do munic√≠pio.
      - "Regi√µes Administrativas": filtra pela regi√£o administrativa.
      - "Todo o Estado": retorna todos os dados.
    """
    if filtro == "Munic√≠pios":
        return data[data['nome_municipio'] == entidade]
    elif filtro == "Regi√µes Administrativas":
        return data[data['regiao_administrativa'] == entidade]
    elif filtro == "Todo o Estado":
        return data
    return pd.DataFrame()

def classificar_propriedades(df):
    """
    Classifica as propriedades com base em seu tamanho em rela√ß√£o ao m√≥dulo fiscal de cada registro:
        1. Minif√∫ndio: 0 < √†rea < 1MF
        2. Pequena Propriedade: 1 MF ‚â§ √†rea ‚â§ 4 MF
        3. M√©dia Propriedade: 4 MF < √†rea ‚â§ 15 MF
        4. Grande Propriedade: √†rea >15 MF
    Retorna um dicion√°rio com a contagem exata de propriedades em cada categoria e o total.
    """

    # Descartar propriedades com √°rea ou m√≥dulo fiscal vazios
    df = df.dropna(subset=['area', 'modulo_fiscal'])

    # Descartar propriedades com √°rea ou m√≥dulo fiscal iguais a zero
    df = df[(df['area'] != 0) & (df['modulo_fiscal'] != 0)]

    # Retornar None, caso n√£o haja nenhuma propriedade com √°rea e m√≥dulo fiscal v√°lida
    if df.empty:
        return None, None

    cond_minifundio = (df['area'] > 0) & (df['area'] < 1 * df['modulo_fiscal'])
    cond_pequena    = (df['area'] >= 1 * df['modulo_fiscal']) & (df['area'] <= 4 * df['modulo_fiscal'])
    cond_media      = (df['area'] > 4 * df['modulo_fiscal']) & (df['area'] <= 15 * df['modulo_fiscal'])
    cond_grande     = (df['area'] > 15 * df['modulo_fiscal'])

    resultados = {
        "Minifundio": int(cond_minifundio.sum()),
        "Pequena Propriedade": int(cond_pequena.sum()),
        "M√©dia Propriedade": int(cond_media.sum()),
        "Grande Propriedade": int(cond_grande.sum())
    }
    total = len(df)
    return resultados, total

# =============================================================================
# Fun√ß√£o para Exibir Informa√ß√µes em Tabela (Classifica√ß√£o)
# =============================================================================

def display_info_table(titulo, subtitulo, total, resultados):
    """
    Exibe as informa√ß√µes de classifica√ß√£o em uma tabela HTML estilizada.
    """
    info_html = f"""
    <div style="margin-bottom:20px;">
      <table style="width:50%; border-collapse: collapse; margin: auto; box-shadow: 0px 0px 8px rgba(0,0,0,0.1);">
        <caption style="caption-side: top; font-size: 18px; font-weight: bold; padding: 10px;">
          {titulo}<br>
          <span style="font-size: 14px; font-weight: normal;">{subtitulo}</span>
        </caption>
        <thead>
          <tr style="background-color: #836FFF;">
            <th style="padding: 8px; border: 1px solid #fff;">Categoria</th>
            <th style="padding: 8px; border: 1px solid #fff;">Valor</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">Minif√∫ndio</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{resultados.get("Minifundio", 0)}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">Pequena Propriedade</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{resultados.get("Pequena Propriedade", 0)}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">M√©dia Propriedade</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{resultados.get("M√©dia Propriedade", 0)}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">Grande Propriedade</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{resultados.get("Grande Propriedade", 0)}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">Total de Propriedades</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{total}</td>
          </tr>
        </tbody>
      </table>
    </div>
    """
    display(HTML(info_html))

# =============================================================================
# Fun√ß√µes de Plotagem
# =============================================================================

# Add this near the top of the code (with other constants)
cores = {
>>>>>>> otimizacao_de_carga:colab_code/colab_grafico_interativo.py
    "Minif√∫ndio": "#9b19f5",
    "Pequena Propriedade": "#0040bf",
    "M√©dia Propriedade": "#e6d800",
    "Grande Propriedade": "#d97f00",
    "Sem Classifica√ß√£o": "#808080"
}

<<<<<<< HEAD:colab_code/grafico_interativo.py
# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
def carregar_dados(data: pd.DataFrame, regiao: str) -> gpd.GeoDataFrame:
    """Filtra e prepara os dados para a regi√£o especificada."""
    df = data[
        (data['regiao_administrativa'] == regiao) &
        data['geom'].notna() &
        data['geom'].apply(lambda x: isinstance(x, str))
    ].copy()
    if df.empty:
        raise ValueError(f"Nenhum dado v√°lido encontrado para: {regiao}")

    # Converte WKT ‚Üí geometry
    def to_geom(w):
        try: return wkt.loads(w)
        except: return None

    df['geometry'] = df['geom'].apply(to_geom)
    df = df[df['geometry'].notna()]

    return gpd.GeoDataFrame(df, geometry='geometry', crs='EPSG:31984').to_crs(epsg=4326)

# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
def classificar_propriedades(gdf: gpd.GeoDataFrame) -> gpd.GeoDataFrame:
    """Classifica as propriedades em categorias."""
    conds = [
        (gdf['area'] > 0) & (gdf['area'] < gdf['modulo_fiscal']),
        (gdf['area'] >= gdf['modulo_fiscal']) & (gdf['area'] <= 4 * gdf['modulo_fiscal']),
        (gdf['area'] > 4 * gdf['modulo_fiscal']) & (gdf['area'] <= 15 * gdf['modulo_fiscal']),
        (gdf['area'] > 15 * gdf['modulo_fiscal'])
    ]
    cats = list(CORES.keys())[:-1]  # ignora o "Sem Classifica√ß√£o"
    gdf['categoria'] = np.select(conds, cats, default="Sem Classifica√ß√£o")
    return gdf

# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
def criar_mapa_simples(gdf: gpd.GeoDataFrame, regiao: str) -> folium.Map:
    """Cria o mapa folium centrado na regi√£o."""
    centro = gdf.geometry.centroid.unary_union.centroid
    m = folium.Map(location=[centro.y, centro.x], zoom_start=9)
    for _, row in gdf.iterrows():
        folium.GeoJson(
            row.geometry,
            style_function=lambda feat, cat=row['categoria']: {
                'fillColor': CORES.get(cat, CORES["Sem Classifica√ß√£o"]),
                'color': 'black',
                'weight': 0.5,
                'fillOpacity': 0.7
            },
            tooltip=(
                f"<strong>{row['nome_municipio']}</strong><br>"
                f"√Årea: {row['area']} ha<br>"
                f"Categoria: {row['categoria']}"
            )
        ).add_to(m)

    # Legenda fixa
    legend = f'''
    <div style="position: fixed; bottom: 50px; left: 50px; z-index:1000;
                background:white; padding:10px; border:2px solid grey;
                border-radius:5px; font-size:14px;">
      <strong>{regiao}</strong><br>
      {'<br>'.join([f'<i style="color:{c}">‚ñ†</i> {cat}' for cat,c in CORES.items()])}
    </div>
    '''
    m.get_root().html.add_child(folium.Element(legend))
    return m

# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
def mostrar_mapa_regiao(data: pd.DataFrame, regiao: str):
    """Fun√ß√£o principal que limpa, classifica e exibe o mapa."""
    clear_output(wait=True)
    display(dropdown)  # mant√©m o dropdown vis√≠vel
    try:
        print(f"üîç Processando regi√£o: {regiao}")
        gdf = carregar_dados(data, regiao)
        gdf = classificar_propriedades(gdf)
        print(f"‚úÖ Propriedades v√°lidas: {len(gdf)}")
        print("üìä Distribui√ß√£o:")
        print(gdf['categoria'].value_counts().to_string())
        print("üñ±Ô∏è Gerando mapa...")
        mapa = criar_mapa_simples(gdf, regiao)
        display(mapa)
    except Exception as e:
        print(f"‚ùå Erro: {e}")

# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
# Cria e exibe o dropdown
regioes = sorted(data['regiao_administrativa'].unique())
dropdown = widgets.Dropdown(
    options=regioes,
    description='Escolha a Regi√£o:',
    style={'description_width': 'initial'},
    layout=widgets.Layout(width='60%')
)
dropdown.observe(lambda change: mostrar_mapa_regiao(data, change.new), names='value')
display(dropdown)

# (Opcional) chama uma vez para a primeira regi√£o padr√£o
mostrar_mapa_regiao(data, regioes[0])
=======
# Modify the plot_barras function:
def plot_barras(resultados, titulo, subtitulo):
    """
    Plota gr√°fico de barras com os valores e anota os totais acima de cada barra.
    """
    # Map category names to colors
    color_map = {
        "Minifundio": cores["Minif√∫ndio"],
        "Pequena Propriedade": cores["Pequena Propriedade"],
        "M√©dia Propriedade": cores["M√©dia Propriedade"],
        "Grande Propriedade": cores["Grande Propriedade"]
    }

    # Get colors in correct order
    colors = [color_map[cat] for cat in resultados.keys()]

    plt.figure(figsize=(12, 8))
    bars = plt.bar(resultados.keys(), resultados.values(), color=colors, edgecolor='black', alpha=0.85)
    plt.title(f"{titulo}\n{subtitulo}", fontsize=16)
    plt.xlabel("Categoria", fontsize=14)
    plt.ylabel("N√∫mero de Propriedades", fontsize=14)
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    plt.xticks(rotation=45, fontsize=12)

    for bar in bars:
        height = bar.get_height()
        plt.annotate(f'{int(height)}',
                     xy=(bar.get_x() + bar.get_width()/2, height),
                     xytext=(0, 3),
                     textcoords="offset points",
                     ha='center', va='bottom')
    plt.tight_layout()
    plt.show()

# Modify the plot_pizza function:
def plot_pizza(resultados, titulo, subtitulo):
    """
    Plota gr√°fico de pizza com percentuais e legenda.
    Esse gr√°fico √© t√£o gostoso quanto uma fatia de pizza (sem exageros, ok?).
    """
    # Map category names to colors
    color_map = {
        "Minifundio": cores["Minif√∫ndio"],
        "Pequena Propriedade": cores["Pequena Propriedade"],
        "M√©dia Propriedade": cores["M√©dia Propriedade"],
        "Grande Propriedade": cores["Grande Propriedade"]
    }

    # Get colors in correct order
    colors = [color_map[cat] for cat in resultados.keys()]

    plt.figure(figsize=(10, 10))
    wedges, texts, autotexts = plt.pie(list(resultados.values()),
                                       labels=None,
                                       autopct='%1.1f%%',
                                       startangle=90,
                                       colors=colors,
                                       pctdistance=0.8)
    plt.title(f"{titulo}\n{subtitulo}", fontsize=16)
    plt.axis('equal')
    plt.legend(wedges, resultados.keys(), title="Tipos de Propriedade",
               loc="center left", bbox_to_anchor=(1, 0, 0.5, 1))
    plt.tight_layout()
    plt.show()

# =============================================================================
# Fun√ß√£o para Exibir Estat√≠sticas Adicionais em Tabela
# =============================================================================

def display_stats_table(data):
    """
    Exibe uma tabela com estat√≠sticas adicionais do dataset da Malha Fundi√°ria.
    √â como o "por tr√°s das c√¢meras" que revela todos os segredos!
    """
    total_properties = len(data)
    missing_area = data['area'].isna().sum()
    missing_modulo = data['modulo_fiscal'].isna().sum()

    valid_data = data.dropna(subset=['area', 'modulo_fiscal'])
    valid_data = valid_data[(valid_data['area'] != 0) & (valid_data['modulo_fiscal'] != 0)]
    valid_data = valid_data[valid_data['nome_municipio'].notna()]
    total_valid = len(valid_data)

    total_municipios = len(data['nome_municipio'].dropna().unique())
    valid_municipios = len(valid_data['nome_municipio'].dropna().unique())

    # Classifica√ß√£o por munic√≠pio (para determinar a categoria dominante)
    conditions = [
        (valid_data['area'] > 0) & (valid_data['area'] < 1 * valid_data['modulo_fiscal']),
        (valid_data['area'] >= 1 * valid_data['modulo_fiscal']) & (valid_data['area'] <= 4 * valid_data['modulo_fiscal']),
        (valid_data['area'] > 4 * valid_data['modulo_fiscal']) & (valid_data['area'] <= 15 * valid_data['modulo_fiscal']),
        (valid_data['area'] > 15 * valid_data['modulo_fiscal'])
    ]
    choices = ["Minifundio", "Pequena Propriedade", "M√©dia Propriedade", "Grande Propriedade"]
    valid_data = valid_data.copy()
    valid_data['categoria'] = np.select(conditions, choices, default="NaoClassificado")

    # Determinar a categoria dominante para cada munic√≠pio
    dominancia = valid_data.groupby('nome_municipio')['categoria'].agg(lambda x: x.value_counts().idxmax())
    dominancia_counts = dominancia.value_counts()
    dom_minifundio = dominancia_counts.get("Minifundio", 0)
    dom_pequena = dominancia_counts.get("Pequena Propriedade", 0)
    dom_media = dominancia_counts.get("M√©dia Propriedade", 0)
    dom_grande = dominancia_counts.get("Grande Propriedade", 0)

    # Determinar o n√∫mero de propriedades com √°reaiguala zero
    zero_area = (data['area'] == 0).sum()

    # Determinar a quantidade de propriedades com informa√ß√£o do nome do munic√≠pio faltando ou vazia
    missing_municipio = data['nome_municipio'].isna().sum()

    stats = {
        "Propriedades lidas do Dataset": total_properties,
        "Propriedades descartados por falta de √Äreas": missing_area,
        "Propriedades descartados por falta de M√≥dulos Fiscais do Munic√≠pios": missing_modulo,
        "Propriedades descartasda por √Åreas igual a zero": zero_area,
        "Propriedades descartadas por falta de munic√≠pio": missing_municipio,
        "Propriedades efetivamente utilizadas": total_valid,
        "Munic√≠pios c/ Domin√¢ncia de Minif√∫ndios": dom_minifundio,
        "Munic√≠pios c/ Domin√¢ncia de Pequenas Propriedades": dom_pequena,
        "Munic√≠pios c/ Domin√¢ncia de M√©dias Propriedades": dom_media,
        "Munic√≠pios c/ Domin√¢ncia de Grandes Propriedades": dom_grande
    }

    stats_html = f"""
    <div style="margin-top:20px;">
      <table style="width:70%; border-collapse: collapse; margin: auto; box-shadow: 0px 0px 8px rgba(0,0,0,0.1);">
        <caption style="caption-side: top; font-size: 18px; font-weight: bold; padding: 10px;">
          Estat√≠sticas Adicionais
        </caption>
        <thead>
          <tr style="background-color: #20B2AA;">
            <th style="padding: 8px; border: 1px solid #fff;">M√©trica</th>
            <th style="padding: 8px; border: 1px solid #fff;">Valor</th>
          </tr>
        </thead>
        <tbody>
    """
    for key, value in stats.items():
        stats_html += f"""
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">{key}</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{value}</td>
          </tr>
        """
    stats_html += """
        </tbody>
      </table>
    </div>
    """
    display(HTML(stats_html))

# =============================================================================
# Fun√ß√£o Principal de Plotagem e Exibi√ß√£o
# =============================================================================

def plot_resultado(data, filtro, entidade, tipo_grafico):
    df_filtrado = filtrar_dados(data, filtro, entidade)
    classificacao, total = classificar_propriedades(df_filtrado)

    if classificacao is None:
        display(HTML(f"<p style='color:red;'>Propriedade registrada para {filtro} {entidade if entidade else ''}.</p>"))
        return

    if filtro == "Munic√≠pios":
        titulo = f"Classifica√ß√£o de Propriedades no Munic√≠pio '{entidade}'"
        subtitulo = f"Total de Propriedades: {total}"
    elif filtro == "Regi√µes Administrativas":
        titulo = f"Classifica√ß√£o de Propriedades na Regi√£o Administrativa '{entidade}'"
        subtitulo = f"Total de Propriedades: {total}"
    elif filtro == "Todo o Estado":
        titulo = "Classifica√ß√£o de Propriedades em Todo o Estado"
        subtitulo = f"Total de Propriedades: {total}"
    else:
        titulo, subtitulo = "Classifica√ß√£o de Propriedades", ""

    # Exibe a tabela de classifica√ß√£o (antes do gr√°fico)
    display_info_table(titulo, subtitulo, total, classificacao)

    # Exibe o gr√°fico (Barras ou Pizza)
    if tipo_grafico == "Barras":
        plot_barras(classificacao, titulo, subtitulo)
    elif tipo_grafico == "Pizza":
        plot_pizza(classificacao, titulo, subtitulo)

    # Exibe a tabela com estat√≠sticas adicionais ap√≥s o gr√°fico
    display_stats_table(data)

# =============================================================================
# Interface Interativa com ipywidgets
# =============================================================================

def create_interface(data):
    # Use WidgetHTML aqui para widgets
    filtro_title = WidgetHTML("<h3>Definir a exibi√ß√£o dos dados</h3>")

    municipios = sorted(data['nome_municipio'].dropna().unique())
    regioes = sorted(data['regiao_administrativa'].dropna().unique())

    dropdown_tipo = Dropdown(
        options=["Todo o Estado", "Munic√≠pios", "Regi√µes Administrativas"],
        value="Todo o Estado",
        description="Mostrar por:",
        style={'description_width': 'initial'}
    )

    dropdown_entidade = Dropdown(
        description="Selecionar Entidade:",
        style={'description_width': 'initial'}
    )

    dropdown_grafico = Dropdown(
        options=["Barras", "Pizza"],
        value="Barras",
        description="Tipo de Gr√°fico:",
        style={'description_width': 'initial'}
    )

    controls_box = VBox([filtro_title, dropdown_tipo, dropdown_entidade, dropdown_grafico])
    output = Output()

    def update_entidade(*args):
        filtro = dropdown_tipo.value
        if filtro == "Munic√≠pios":
            dropdown_entidade.options = municipios
            dropdown_entidade.value = municipios[0] if municipios else None
            dropdown_entidade.disabled = False
        elif filtro == "Regi√µes Administrativas":
            dropdown_entidade.options = regioes
            dropdown_entidade.value = regioes[0] if regioes else None
            dropdown_entidade.disabled = False
        else:
            dropdown_entidade.options = []
            dropdown_entidade.disabled = True

    def update_plot(*args):
        with output:
            output.clear_output()
            filtro = dropdown_tipo.value
            entidade = dropdown_entidade.value if not dropdown_entidade.disabled else None
            tipo_grafico = dropdown_grafico.value
            plot_resultado(data, filtro, entidade, tipo_grafico)

    dropdown_tipo.observe(lambda change: (update_entidade(), update_plot()), names='value')
    dropdown_entidade.observe(lambda change: update_plot(), names='value')
    dropdown_grafico.observe(lambda change: update_plot(), names='value')

    update_entidade()
    update_plot()

    main_box = HBox([controls_box, output])
    display(main_box)
    #data.to_csv("/content/drive/MyDrive/Projetos/2024-governanca-fundiaria/[DATA-TO-ANALYSIS]/data_to_colab/dataset-malha-fundiaria-idace_preprocessado-2025-04-10.csv",index=False)


# =============================================================================
# Execu√ß√£o da Interface
# =============================================================================

create_interface(data)
>>>>>>> otimizacao_de_carga:colab_code/colab_grafico_interativo.py
