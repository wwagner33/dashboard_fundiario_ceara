<<<<<<< HEAD
import streamlit as st

st.set_page_config(
    page_title="Dashboard FundiÃ¡rio CE",
    layout="wide",
    page_icon="ðŸŒ¾"
)

st.title("ðŸŒ¾ Dashboard FundiÃ¡rio do Estado do CearÃ¡")
st.markdown("Selecione uma pÃ¡gina no menu lateral para visualizar os dados.")
=======
# app.py


import streamlit as st
import pandas as pd
from streamlit_folium import st_folium

from modules import (
    load_csv_data as load_data,
    load_municipios,
    validate_data,
    filtrar_dados,
    classificar_propriedades,
    plot_barras,
    plot_pizza,
    compute_stats_df,
    load_municipios,
    preparar_dados as preparar_dados_ctx,
    criar_mapa_contextual,
    preprocessar_tudo,
    criar_mapa_com_camadas,
)

# -----------------------------
# ðŸ”’ AplicaÃ§Ã£o de Cache
# -----------------------------

# Cacheia a leitura de CSVs e DataFrames pesados (expira em 1h)
load_data = st.cache_data(ttl=3600)(
    load_data
)  # :contentReference[oaicite:2]{index=2} :contentReference[oaicite:3]{index=3}

# Cacheia validaÃ§Ãµes e splits de dados (poupando re-execuÃ§Ãµes)
validate_data = st.cache_data()(validate_data)  # :contentReference[oaicite:4]{index=4}

# Cacheia filtros, classificaÃ§Ãµes e estatÃ­sticas
filtrar_dados = st.cache_data()(filtrar_dados)
classificar_propriedades = st.cache_data()(classificar_propriedades)
compute_stats_df = st.cache_data()(
    compute_stats_df
)  # :contentReference[oaicite:5]{index=5}

# Cacheia GeoDataFrame de municÃ­pios e preparaÃ§Ã£o de contexto
load_municipios = st.cache_data()(load_municipios)
preparar_dados_ctx = st.cache_data()(preparar_dados_ctx)
preprocessar_tudo = st.cache_data()(
    preprocessar_tudo
)  # :contentReference[oaicite:6]{index=6}

# -----------------------------
# ðŸš€ App Streamlit
# -----------------------------

st.set_page_config(
    page_title="ccTerra::AnÃ¡lise da ConcentraÃ§Ã£o FundiÃ¡ria do CearÃ¡",
    page_icon="ðŸŒ¿",
    layout="wide",
    initial_sidebar_state="expanded",
)

with open("style.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

st.title("ccTerra::ConcentraÃ§Ã£o FundiÃ¡ria")

# Carrega e valida dados
DATA_FOLDER = "data/"
df_raw = load_data(DATA_FOLDER)
df_all, df_class, df_inter, df_ctx, counts = validate_data(df_raw)

# 2) Resumo de Dados na sidebar # Usado para debug
# descricao_map = { # Usado para debug
#     "total_carregados": "Total carregados",
#     "validos_classificacao": "VÃ¡lidos classificaÃ§Ã£o",
#     "validos_mapa_interativo": "VÃ¡lidos mapa interativo",
#     "validos_mapa_contextual": "VÃ¡lidos mapa contextual",
#     "descartados": "Descartados",
# }
# resumo = (
#     pd.DataFrame.from_dict(counts, orient="index", columns=["Quantidade"])
#     .rename_axis("chave")
#     .reset_index()
#     .assign(DescriÃ§Ã£o=lambda df: df["chave"].map(descricao_map))[
#         ["DescriÃ§Ã£o", "Quantidade"]
#     ]
# ) # Usado para debug
# st.sidebar.subheader("Resumo de Dados") # Usado para debug
# st.sidebar.table(resumo) # Usado para debug

# NavegaÃ§Ã£o
page = st.sidebar.selectbox(
    "NavegaÃ§Ã£o", ["GrÃ¡ficos", "Mapa Contextual", "Mapa Interativo"]
)

# LÃ³gica por aba
if page == "GrÃ¡ficos":
    opcao = st.sidebar.selectbox(
        "Mostrar por", ["Todo o Estado", "MunicÃ­pios", "RegiÃµes Administrativas"]
    )
    entidade = None
    if opcao != "Todo o Estado":
        col = "nome_municipio" if opcao == "MunicÃ­pios" else "regiao_administrativa"
        entidade = st.sidebar.selectbox(
            f"Selecionar {opcao}", sorted(df_class[col].dropna().unique())
        )
    tipo_grafico = st.sidebar.radio("Tipo de grÃ¡fico", ["Barras", "Pizza"])

    df_filtrado = filtrar_dados(df_class, opcao, entidade)
    resultados, total = classificar_propriedades(df_filtrado)

    if resultados:
        st.subheader(f"ClassificaÃ§Ã£o de Propriedades ({opcao})")
        df_tab = pd.DataFrame(
            list(resultados.items()), columns=["Categoria", "Quantidade"]
        )
        df_tab.loc[len(df_tab)] = ["Total", total]
        st.table(df_tab)

        if tipo_grafico == "Barras":
            fig = plot_barras(resultados, f"Propriedades - {opcao}", f"Total: {total}")
        else:
            fig = plot_pizza(resultados, f"Propriedades - {opcao}", f"Total: {total}")
        st.pyplot(fig)

        st.subheader("EstatÃ­sticas Adicionais")
        st.table(compute_stats_df(df_class))
    else:
        st.warning("Nenhum dado disponÃ­vel para o filtro selecionado.")

elif page == "Mapa Contextual":
    muni_gdf = load_municipios(DATA_FOLDER)
    gdf_ctx = preparar_dados_ctx(df_ctx, muni_gdf)
    mapa = criar_mapa_contextual(gdf_ctx)
    st_folium(mapa, width=800, height=600)

else:  # Mapa Interativo
    #gdf_inter = preprocessar_tudo(df_inter)
    sel_regiao = st.sidebar.selectbox(
        "RegiÃ£o Administrativa", sorted(df_inter["regiao_administrativa"].unique())
    )
    mapa = criar_mapa_com_camadas(df_inter, sel_regiao)
    st_folium(mapa, width=800, height=600)
>>>>>>> otimizacao_de_carga
